<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>$(CompilerNetFramework)</TargetFramework>
    <IsPackable>true</IsPackable>
    <OutputPath>$(NScriptToolsetDir)</OutputPath>
    <PackageType>MSBuildSdk</PackageType>
    <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
    <BuildOutputTargetFolder>tools</BuildOutputTargetFolder>
  </PropertyGroup>

  <Target Name="_WriteSharedFiles" AfterTargets="Build">
        <PropertyGroup>
            <_GlobalJson>
                <![CDATA[
{
  "$schema": "https://json.schemastore.org/global.json",
  "msbuild-sdks": {
    "NScript.Sdk": "$(Version)"
  }
}
                ]]>
            </_GlobalJson>
            <_NuGetConfig>
                <![CDATA[
<configuration>
    <config>
        <add key="globalPackagesFolder" value="$(PackageRestorePath)" />
    </config>
    <packageSources>
        <add key="foo-sdk" value="$(PackageOutputPath)" />
    </packageSources>
</configuration>
                ]]>
            </_NuGetConfig>
        </PropertyGroup>

        <WriteLinesToFile File="../../Framework/global.json" Lines="$(_GlobalJson)" Overwrite="true" WriteOnlyWhenDifferent="true" />
        <WriteLinesToFile File="../../Framework/nuget.config" Lines="$(_NuGetConfig)" Overwrite="true" WriteOnlyWhenDifferent="true" />
        <WriteLinesToFile File="../../../Test/Framework/global.json" Lines="$(_GlobalJson)" Overwrite="true" WriteOnlyWhenDifferent="true" />
        <WriteLinesToFile File="../../../Test/Framework/nuget.config" Lines="$(_NuGetConfig)" Overwrite="true" WriteOnlyWhenDifferent="true" />
    </Target>

  <ItemGroup>
    <None Include="Sdk/*" Pack="true" PackagePath="%(RelativeDir)" />
  </ItemGroup>

  <!--<ItemGroup>
    <Content Include="$(NScriptToolsetDir)/TestStuff/**/*" Pack="true" PackagePath="TestStuff/" />
  </ItemGroup>-->

    <Target Name="_ClearPackageCache" AfterTargets="Build">
      <PropertyGroup>
          <_PackageDirectory>$(PackageRestorePath)$(PackageId.ToLowerInvariant())</_PackageDirectory>
      </PropertyGroup>

      <RemoveDir Directories="$(_PackageDirectory)" Condition="Exists('$(_PackageDirectory)')" />
    </Target>

  <ItemGroup>
    <ProjectReference Include="..\NScript\NScript.csproj" />
    <ProjectReference Include="..\JsCsc\JsCsc.csproj" />
  </ItemGroup>

  <PropertyGroup>
    <TargetsForTfmSpecificBuildOutput>$(TargetsForTfmSpecificBuildOutput);CopyExtrasToPackage</TargetsForTfmSpecificBuildOutput>
    <TargetsForTfmSpecificContentInPackage>$(TargetsForTfmSpecificContentInPackage);CopyLibStuff</TargetsForTfmSpecificContentInPackage>
  </PropertyGroup>

  <Target Name="CopyExtrasToPackage" DependsOnTargets="ResolveReferences">
    <ItemGroup>
      <BuildOutputInPackage Include="@(ToolStuff)" />
    </ItemGroup>
  </Target>

  <Target Name="CopyLibStuff" DependsOnTargets="ResolveReferences">
    <ItemGroup>
      <TfmSpecificPackageFile Include="@(LibStuff)">
        <!--<FinalOutputPath>$(NScriptToolsetDir)/lib</FinalOutputPath>-->
        <PackagePath>lib</PackagePath>
      </TfmSpecificPackageFile>
    </ItemGroup>
  </Target>

  <ItemGroup>
    <ToolStuff Include="$(NScriptToolsetDir)/bin/$(CompilerNetFramework)/**/*" />
  </ItemGroup>

  <ItemGroup>
    <LibStuff Include="$(NScriptToolsetDir)/lib/*" />
  </ItemGroup>

</Project>
